<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"
    />
    <title>vote</title>
    <style>
      html,
      body {
        padding: 0;
        margin: 0;
        height: 100%;
        overflow: hidden;
      }
      .vote-box {
        height: 100%;
        width: 100%;
        background: url("../img/bkpp-bc.png") no-repeat center bottom;
        background-size: cover;
      }
      .vote {
        display: flex;
        justify-content: space-between;
        padding: 30px;
        align-items: center;
        height: 50%;
      }
      .vote-open {
        background: #fff;
        border-radius: 4px;
        height: 30px;
        line-height: 30px;
        padding: 0 10px;
      }
      .vote-close {
        background: #fff;
        border-radius: 4px;
        height: 30px;
        line-height: 30px;
        padding: 0 10px;
      }
      .vote-num {
        display: block;
        height: calc(50% - 30px);
        overflow-y: auto;
        font-size: 12px;
        color: #fff;
        text-align: center;
        overflow: scroll;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div class="vote-box">
      <div class="vote">
        <div class="vote-open" onclick="openVote()">开启投票</div>
        <div class="vote-close" onclick="closeVote()">关闭投票</div>
      </div>
      <div class="vote-num"></div>
    </div>

    <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="../js/sweetAlert.min.js"></script>
    <script type="text/javascript" src="../js/randomGen.js"></script>
    <script type="text/javascript" src="../js/provinces.js"></script>
    <script>
      // 声明变量
      let baseObj = {
        fullname: stringGen("name", 8),
        phone: phoneNumGen(),
        email: emailGen(),
        province_id: provinceGen(),
        vote: [
          {
            award_id: 14,
            contender_id: 64, // bk
          },
          {
            award_id: 16,
            contender_id: 76, // pp
          },
          {
            award_id: 18,
            contender_id: 86, // itsay
          },
        ],
      };
      let timer = null;
      let timerArr = [];
      // 循环ip,发送请求
      function forVote() {
        let successNum = 0;
        let failNum = 0;
        let timeDate = formatDate();

        for (let i = 0; i < 20; i++) {
          let item = ipGen();
          let baseItem = { ...baseObj, ...item };
          votePost(baseItem);
        }
        timerArr.push({ time: timeDate });

        $(".vote-num").html("");
        for (let j = 0; j < timerArr.length; j++) {
          let item = timerArr[j];
          $(".vote-num").append(`<div>当前时间：${item.time}投票</div>`);
        }
      }

      // fetch 发送请求 【json】
      function votePost(item) {
        fetch("https://api.komchadluek.net/api/award/vote", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            token:
              "VUkTC4BtyUGVt6u2UnF76BcKjXB9pu2zKEazSVudMzSDQfZsDkQS3wAjxwa7mg2MZWfRyers7N9ygv8Hb7hyPUXqpsZyqqpURkRJzzB67LYBGDB8PhVWBDS6v5mBVnVW",
          },
          body: JSON.stringify({
            ...item,
          }),
        })
          .then((res) => {
            console.log(res);
            return res.json();
          })
          .then((json) => {
            console.log("获取的结果", json);
            return json;
          })
          .catch((err) => {
            console.log("请求错误", err);
          });
      }

      // 开启轮询
      function openVote() {
        swal({
          title: "开启投票啦!",
          text: "哇哦!",
          icon: "success",
        });
        if (timer) {
          swal({
            title: "已经开启投票啦，不要重复开启呦!",
            text: "哇哦!",
            icon: "success",
          });
          return;
        }

        // 进入页面请求一次
        forVote();

        // 开启时间轮询，为容错尽量11分钟一次
        timer = setInterval(() => {
          forVote();
        }, 1000 * 60 * 11);
      }

      //关闭轮询
      function closeVote() {
        swal({
          title: "投票关闭啦!",
          text: "哇哦!",
          icon: "success",
        });
        if (timer) {
          clearInterval(timer);
          timer = null;
          timerArr = [];
          $(".vote-num").html("");
        }
      }

      //换算当前时间
      function formatDate() {
        var dateTime = new Date().getTime();
        var date = new Date(dateTime);
        let monthT = date.getMonth() + 1;
        return `${date.getFullYear()}-${monthT < 10 ? "0" + monthT : monthT}-${
          date.getDate() < 10 ? "0" + date.getDate() : date.getDate()
        } ${date.getHours() < 10 ? "0" + date.getHours() : date.getHours()}:${
          date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes()
        }:${
          date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds()
        }`;
      }
    </script>
  </body>
</html>
